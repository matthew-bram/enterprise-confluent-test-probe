# REST API Endpoints Reference

## Table of Contents
- [Overview](#overview)
- [Base URL and Versioning](#base-url-and-versioning)
- [Authentication](#authentication)
- [Endpoints](#endpoints)
  - [GET /api/v1/health](#get-apiv1health)
  - [POST /api/v1/test/initialize](#post-apiv1testinitialize)
  - [POST /api/v1/test/start](#post-apiv1teststart)
  - [GET /api/v1/test/{testId}/status](#get-apiv1testtestidstatus)
  - [GET /api/v1/queue/status](#get-apiv1queuestatus)
  - [DELETE /api/v1/test/{testId}](#delete-apiv1testtestid)
- [Common Response Patterns](#common-response-patterns)
- [Related Documentation](#related-documentation)

## Overview

The Test Probe REST API provides 6 endpoints for managing test executions in the event-driven architecture (EDA) testing framework. All endpoints follow RESTful conventions with resource-oriented design.

**API Characteristics:**
- RESTful design (GET, POST, DELETE)
- JSON request/response format (application/json)
- UUID-based resource identifiers
- Consistent error responses (RFC 7807-inspired)
- Graceful degradation (circuit breaker)

## Base URL and Versioning

**Development:**
```
http://localhost:8080/api/v1
```

**Docker/Kubernetes:**
```
http://test-probe:8080/api/v1
```

**Versioning Strategy:**
- API version in URL path (`/api/v1/...`)
- Breaking changes require new version (`/api/v2/...`)
- Non-breaking changes (new optional fields) stay in v1

## Authentication

**Current:** No authentication (intended for internal/trusted networks).

**Future:** Consider adding:
- API key authentication
- JWT bearer tokens
- mTLS for service-to-service

## Endpoints

---

### GET /api/v1/health

**Summary:** Health check verifying actor system responsiveness.

**Purpose:**
- Kubernetes liveness/readiness probe
- Load balancer health check
- Monitoring/alerting

#### Request

**Method:** GET
**Path:** `/api/v1/health`
**Headers:** None required
**Body:** None

**Example:**
```bash
curl -X GET http://localhost:8080/api/v1/health
```

#### Success Response (200 OK)

**When:** Actor system responds to health check within timeout.

**Response Body:**
```json
{
  "status": "healthy",
  "actorSystem": "running",
  "timestamp": 1634567890123
}
```

**Fields:**
- `status` (string): "healthy" or "unhealthy"
- `actorSystem` (string): Actor system state ("running", "timeout", "unavailable", "error")
- `error` (string, optional): Error message if unhealthy
- `timestamp` (number): Epoch milliseconds when response generated

#### Failure Response (503 Service Unavailable)

**When:** Actor system timeout, unavailable, or error.

**Response Body (Timeout):**
```json
{
  "status": "unhealthy",
  "actorSystem": "timeout",
  "error": "Actor system did not respond in time",
  "timestamp": 1634567890123
}
```

**Response Body (Circuit Breaker Open):**
```json
{
  "status": "unhealthy",
  "actorSystem": "unavailable",
  "error": "Circuit breaker open - too many failures",
  "timestamp": 1634567890123
}
```

**Response Body (Unexpected Error):**
```json
{
  "status": "unhealthy",
  "actorSystem": "error",
  "error": "Unexpected health check failure",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Actor Communication:**
- Uses `getQueueStatus(None)` to test actor responsiveness
- Ignores queue status details (only cares about response)
- Timeout: 25 seconds (ask timeout)

**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 72-108)

---

### POST /api/v1/test/initialize

**Summary:** Create new test execution context.

**Purpose:**
- Generate unique testId for test execution
- Initialize test state in actor system
- Prepare test for start command

#### Request

**Method:** POST
**Path:** `/api/v1/test/initialize`
**Headers:** None required (no request body)
**Body:** None

**Example:**
```bash
curl -X POST http://localhost:8080/api/v1/test/initialize
```

#### Success Response (201 Created)

**When:** Test initialized successfully.

**Response Body:**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "Test initialized"
}
```

**Fields:**
- `test-id` (UUID): Unique identifier for this test (use in subsequent operations)
- `message` (string): Human-readable confirmation message

#### Error Responses

**503 Service Unavailable:**
```json
{
  "error": "service_unavailable",
  "message": "Circuit breaker open - too many failures",
  "retryAfter": "30s",
  "timestamp": 1634567890123
}
```

**504 Gateway Timeout:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "details": "Ask timeout after 25000 milliseconds",
  "timestamp": 1634567890123
}
```

**500 Internal Server Error:**
```json
{
  "error": "internal_server_error",
  "message": "An unexpected error occurred",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Actor Communication:**
- Sends `InitializeTest` command to GuardianActor
- GuardianActor delegates to QueueActor
- QueueActor creates new TestExecutionActor (FSM)

**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 110-139)

---

### POST /api/v1/test/start

**Summary:** Start test execution with S3 bucket path.

**Purpose:**
- Begin test execution for initialized test
- Provide S3 bucket path for test artifacts (feature files, configs)
- Optionally specify test type

#### Request

**Method:** POST
**Path:** `/api/v1/test/start`
**Headers:** `Content-Type: application/json`
**Body:** JSON (see schema below)

**Request Schema:**
```json
{
  "test-id": "UUID (required)",
  "block-storage-path": "string (required, must start with s3://)",
  "test-type": "string (optional, cannot be empty)"
}
```

**Example (with test-type):**
```bash
curl -X POST http://localhost:8080/api/v1/test/start \
  -H "Content-Type: application/json" \
  -d '{
    "test-id": "550e8400-e29b-41d4-a716-446655440000",
    "block-storage-path": "s3://test-bucket/tests/my-test",
    "test-type": "integration"
  }'
```

**Example (without test-type):**
```bash
curl -X POST http://localhost:8080/api/v1/test/start \
  -H "Content-Type: application/json" \
  -d '{
    "test-id": "550e8400-e29b-41d4-a716-446655440000",
    "block-storage-path": "s3://test-bucket/tests/my-test"
  }'
```

#### Validation Rules

**Validated BEFORE actor communication (fail fast):**

1. **block-storage-path:**
   - Must not be empty (after trim)
   - Must start with `s3://`
   - Must include bucket name (not just `s3://`)

2. **test-type:**
   - If provided, must not be empty string
   - If empty, omit field entirely

**Validation Errors:**
```json
// Empty path
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": "block-storage-path cannot be empty",
  "timestamp": 1634567890123
}

// Invalid S3 path
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": "block-storage-path must be a valid S3 path (s3://bucket/...)",
  "timestamp": 1634567890123
}

// Empty test-type
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": "test-type cannot be empty string (omit field or provide valid value)",
  "timestamp": 1634567890123
}
```

#### Success Response (202 Accepted)

**When:** Test start request accepted (queued for execution).

**Response Body (accepted=true):**
```json
{
  "accepted": true,
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "test-type": "integration",
  "message": "Test started"
}
```

**Response Body (accepted=false):**
```json
{
  "accepted": false,
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "Test already running"
}
```

**Fields:**
- `accepted` (boolean): Whether test start was accepted
- `test-id` (UUID): Test identifier (echo from request)
- `test-type` (string, optional): Test type (if provided or inferred)
- `message` (string): Human-readable result message

**Why 202 Accepted?**
- Test execution is asynchronous (may take minutes)
- Use `GET /test/{testId}/status` to poll for completion
- 202 indicates request accepted, not completed

#### Error Responses

**400 Bad Request (validation):**
```json
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": "block-storage-path must be a valid S3 path (s3://bucket/...)",
  "timestamp": 1634567890123
}
```

**400 Bad Request (business logic):**
```json
{
  "error": "bad_request",
  "message": "Test ID 550e8400-e29b-41d4-a716-446655440000 not found",
  "timestamp": 1634567890123
}
```

**503 Service Unavailable:**
```json
{
  "error": "service_unavailable",
  "message": "Circuit breaker open - too many failures",
  "retryAfter": "30s",
  "timestamp": 1634567890123
}
```

**504 Gateway Timeout:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Validation:** `RestValidation.validateStartRequest(req)` (lines 34-50)
**Conversion:** `RestModelConversions.toCore(req)` â†’ `(UUID, String, Option[String])`
**Actor Communication:** `ServiceInterfaceFunctions.startTest(testId, bucket, testType)`
**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 141-184)

---

### GET /api/v1/test/{testId}/status

**Summary:** Get current status of test execution.

**Purpose:**
- Poll for test completion
- Monitor test progress
- Retrieve execution results

#### Request

**Method:** GET
**Path:** `/api/v1/test/{testId}/status`
**Path Parameters:**
- `testId` (UUID, required): Test identifier from `/test/initialize`

**Headers:** None required
**Body:** None

**Example:**
```bash
curl -X GET http://localhost:8080/api/v1/test/550e8400-e29b-41d4-a716-446655440000/status
```

#### Success Response (200 OK)

**When:** Test status retrieved successfully.

**Response Body (in progress):**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "Testing",
  "bucket": "s3://test-bucket/tests/my-test",
  "test-type": "integration",
  "start-time": 1634567890000,
  "end-time": null,
  "success": null,
  "error": null
}
```

**Response Body (completed successfully):**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "Completed",
  "bucket": "s3://test-bucket/tests/my-test",
  "test-type": "integration",
  "start-time": 1634567890000,
  "end-time": 1634567950000,
  "success": true,
  "error": null
}
```

**Response Body (failed):**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "Exception",
  "bucket": "s3://test-bucket/tests/my-test",
  "test-type": "integration",
  "start-time": 1634567890000,
  "end-time": 1634567920000,
  "success": false,
  "error": "Test execution failed - timeout waiting for Kafka events"
}
```

**Fields:**
- `test-id` (UUID): Test identifier
- `state` (string): Current test state (see FSM states below)
- `bucket` (string): S3 bucket path
- `test-type` (string, optional): Test type
- `start-time` (number, optional): Epoch milliseconds when test started
- `end-time` (number, optional): Epoch milliseconds when test completed/failed
- `success` (boolean, optional): Whether test passed (only set when completed)
- `error` (string, optional): Error message if failed

**Test States (FSM):**
- `Setup`: Test initializing
- `Loading`: Loading test artifacts from S3
- `Loaded`: Artifacts loaded, ready to execute
- `Testing`: Test executing
- `Completed`: Test finished successfully
- `Exception`: Test failed with error

#### Error Responses

**504 Gateway Timeout:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "timestamp": 1634567890123
}
```

**500 Internal Server Error:**
```json
{
  "error": "internal_server_error",
  "message": "An unexpected error occurred",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Actor Communication:** `ServiceInterfaceFunctions.getStatus(testId)`
**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 186-205)

---

### GET /api/v1/queue/status

**Summary:** Get queue status (all tests or filtered by testId).

**Purpose:**
- Monitor overall queue health
- Check queue depth
- Filter for specific test

#### Request

**Method:** GET
**Path:** `/api/v1/queue/status`
**Query Parameters:**
- `testId` (UUID, optional): Filter for specific test

**Headers:** None required
**Body:** None

**Examples:**
```bash
# All tests
curl -X GET http://localhost:8080/api/v1/queue/status

# Specific test
curl -X GET http://localhost:8080/api/v1/queue/status?testId=550e8400-e29b-41d4-a716-446655440000
```

#### Success Response (200 OK)

**When:** Queue status retrieved successfully.

**Response Body (all tests):**
```json
{
  "total-tests": 5,
  "setup-count": 1,
  "loading-count": 1,
  "loaded-count": 0,
  "testing-count": 2,
  "completed-count": 1,
  "exception-count": 0,
  "currently-testing": [
    "550e8400-e29b-41d4-a716-446655440000",
    "660e8400-e29b-41d4-a716-446655440001"
  ]
}
```

**Response Body (filtered by testId):**
```json
{
  "total-tests": 1,
  "setup-count": 0,
  "loading-count": 0,
  "loaded-count": 0,
  "testing-count": 1,
  "completed-count": 0,
  "exception-count": 0,
  "currently-testing": [
    "550e8400-e29b-41d4-a716-446655440000"
  ]
}
```

**Fields:**
- `total-tests` (number): Total tests in queue
- `setup-count` (number): Tests in Setup state
- `loading-count` (number): Tests loading artifacts
- `loaded-count` (number): Tests ready to execute
- `testing-count` (number): Tests currently executing
- `completed-count` (number): Tests completed successfully
- `exception-count` (number): Tests failed with error
- `currently-testing` (array[UUID]): Test IDs currently executing

#### Error Responses

**504 Gateway Timeout:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "timestamp": 1634567890123
}
```

**500 Internal Server Error:**
```json
{
  "error": "internal_server_error",
  "message": "An unexpected error occurred",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Actor Communication:** `ServiceInterfaceFunctions.getQueueStatus(testIdOpt)`
**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 207-228)

---

### DELETE /api/v1/test/{testId}

**Summary:** Cancel test execution.

**Purpose:**
- Cancel running test
- Clean up test resources
- Remove test from queue

#### Request

**Method:** DELETE
**Path:** `/api/v1/test/{testId}`
**Path Parameters:**
- `testId` (UUID, required): Test identifier to cancel

**Headers:** None required
**Body:** None

**Example:**
```bash
curl -X DELETE http://localhost:8080/api/v1/test/550e8400-e29b-41d4-a716-446655440000
```

#### Success Response (200 OK)

**When:** Cancellation request processed (may or may not actually cancel).

**Response Body (cancelled):**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "cancelled": true,
  "message": "Test cancelled"
}
```

**Response Body (not cancelled - already completed):**
```json
{
  "test-id": "550e8400-e29b-41d4-a716-446655440000",
  "cancelled": false,
  "message": "Test already completed"
}
```

**Fields:**
- `test-id` (UUID): Test identifier
- `cancelled` (boolean): Whether test was actually cancelled
- `message` (string): Human-readable result message

**Why 200 OK even if not cancelled?**
- Cancellation is a request, not a guarantee
- Test may complete before cancellation processed
- Client cares about outcome, not just request acceptance

#### Error Responses

**504 Gateway Timeout:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "timestamp": 1634567890123
}
```

**500 Internal Server Error:**
```json
{
  "error": "internal_server_error",
  "message": "An unexpected error occurred",
  "timestamp": 1634567890123
}
```

#### Implementation Details

**Actor Communication:** `ServiceInterfaceFunctions.cancelTest(testId)`
**File:** `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (lines 230-250)

---

## Common Response Patterns

### Timeouts (504 Gateway Timeout)

**All endpoints can return 504 if actor doesn't respond within 25 seconds.**

**Response:**
```json
{
  "error": "actor_timeout",
  "message": "Actor system did not respond in time",
  "details": "Ask timeout after 25000 milliseconds",
  "timestamp": 1634567890123
}
```

**Client Retry Strategy:**
1. Wait 1-5 seconds (exponential backoff)
2. Retry request
3. If timeout persists (3+ retries): Check system health (`GET /health`)

### Service Unavailable (503)

**All endpoints can return 503 when circuit breaker is open.**

**Response:**
```json
{
  "error": "service_unavailable",
  "message": "Circuit breaker open - too many failures",
  "retryAfter": "30s",
  "timestamp": 1634567890123
}
```

**Client Retry Strategy:**
1. Parse `retryAfter` value (30s)
2. Wait 30 seconds (circuit breaker reset time)
3. Retry request
4. If still 503: Wait longer (exponential backoff)

### Internal Server Error (500)

**All endpoints can return 500 for unexpected errors.**

**Response:**
```json
{
  "error": "internal_server_error",
  "message": "An unexpected error occurred. Please contact support if this persists.",
  "timestamp": 1634567890123
}
```

**Client Retry Strategy:**
1. Wait 5-30 seconds (exponential backoff)
2. Retry request (may be transient)
3. If persists: Escalate to operations team

### Validation Errors (400 Bad Request)

**Validation errors include field-specific details.**

**Response:**
```json
{
  "error": "validation_error",
  "message": "Request validation failed",
  "details": "block-storage-path must be a valid S3 path (s3://bucket/...)",
  "timestamp": 1634567890123
}
```

**Client Action:** Fix input, don't retry with same data.

## Related Documentation

**Architecture:**
- [REST API Architecture](03.1-rest-api-architecture.md) - Overall design
- [REST Error Handling](03.1-rest-error-handling.md) - Exception and rejection handling
- [REST Timeouts & Resilience](03.1-rest-timeouts-resilience.md) - Configuration guide
- [OpenAPI Specification](../../../../api/rest-api-openapi-specification.md) - Complete API spec

**OpenAPI Spec:**
- `/test-probe-interfaces/src/main/resources/openapi.yaml` (700+ lines, complete endpoint documentation)

**Implementation Files:**
- `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestRoutes.scala` (256 lines)
- `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/rest/RestValidation.scala` (91 lines)
- `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/models/rest/RestModels.scala` (DTO schemas)
- `/test-probe-interfaces/src/main/scala/com/company/probe/interfaces/models/rest/RestModelConversions.scala` (80 lines, anti-corruption layer)

**Tests:**
- `/test-probe-interfaces/src/test/scala/com/company/probe/interfaces/rest/RestRoutesHealthCheckSpec.scala` (280 lines, 10 tests)
- `/test-probe-interfaces/src/test/scala/com/company/probe/interfaces/rest/RestRoutesErrorHandlingSpec.scala` (704 lines, 27 tests)
- `/test-probe-interfaces/src/test/scala/com/company/probe/interfaces/rest/RestValidationSpec.scala` (247 lines, 19 tests)

---

**Last Updated:** 2025-10-19
**Status:** Production-Ready
**Module:** test-probe-interfaces
**Endpoints:** 6 (Health, Initialize, Start, Status, Queue Status, Cancel)
