# 07.2 Event Models

**Last Updated:** 2025-11-26
**Status:** Active - CloudEvents 1.0 compliant
**Component:** Event Domain Models
**Related Documents:**
- [07 Models Overview](07-models-overview.md)
- [07.1 Probe Testing Models](07.1-probe-testing-models.md)
- [10.2 Serdes DSL Architecture](../10%20Kafka%20Streaming/10.2%20Serialization/10.2-serdes-dsl-architecture.md)
- [ADR-SERDES-001: JSON Schema Serialization](../../adr/ADR-SERDES-001-confluent-json-schema-serialization-strategy.md)

---

## Table of Contents

- [Overview](#overview)
- [CloudEvent Structure](#cloudevent-structure)
- [Event Serialization Formats](#event-serialization-formats)
- [Schema Evolution Patterns](#schema-evolution-patterns)
- [Related Documents](#related-documents)

---

## Overview

Test-Probe uses CloudEvents 1.0 specification for all Kafka message keys, ensuring interoperability and standardization across event-driven systems. Event payloads support multiple serialization formats (JSON, Avro, Protobuf) via Confluent Schema Registry.

**Design Principles:**

1. **CloudEvents Standard**: All keys conform to CloudEvents 1.0 specification
2. **Polymorphic Values**: Multiple event types on same topic using JSON Schema `oneOf`
3. **Schema Registry**: Centralized schema management and evolution
4. **Type Safety**: Compile-time guarantees through Scala case classes

---

## CloudEvent Structure

**Definition:**
```scala
package io.distia.probe.core.pubsub.models

import com.fasterxml.jackson.annotation.JsonTypeName
import com.kjetland.jackson.jsonSchema.annotations.JsonSchemaTitle

@JsonSchemaTitle("CloudEvent")
@JsonTypeName("CloudEvent")
final case class CloudEvent(
  id: String,
  source: String,
  specversion: String = "1.0",
  `type`: String,
  time: String,
  subject: String,
  datacontenttype: String = "application/octet-stream",
  correlationid: String,
  payloadversion: String,
  time_epoch_micro_source: Long = 0L
)
```

**CloudEvents 1.0 Fields:**

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| `id` | Yes | Unique event identifier | "evt-abc-123" |
| `source` | Yes | Event producer identifier | "order-service" |
| `specversion` | Yes | CloudEvents version | "1.0" |
| `type` | Yes | Event type | "OrderCreated" |
| `time` | Yes | ISO 8601 timestamp | "2025-11-26T10:15:23Z" |
| `subject` | Yes | Event subject/resource | "order/12345" |
| `datacontenttype` | Yes | Payload MIME type | "application/json" |
| `correlationid` | Extension | Correlation ID | "corr-abc-123" |
| `payloadversion` | Extension | Schema version | "v2.0" |
| `time_epoch_micro_source` | Extension | Source timestamp (microseconds) | 1732626923000000 |

**Example:**
```json
{
  "id": "evt-abc-123",
  "source": "order-service",
  "specversion": "1.0",
  "type": "OrderCreated",
  "time": "2025-11-26T10:15:23.000Z",
  "subject": "order/12345",
  "datacontenttype": "application/json",
  "correlationid": "corr-abc-123",
  "payloadversion": "v2.0",
  "time_epoch_micro_source": 1732626923000000
}
```

**JSON Schema:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CloudEvent",
  "type": "object",
  "properties": {
    "id": {"type": "string"},
    "source": {"type": "string"},
    "specversion": {"type": "string", "const": "1.0"},
    "type": {"type": "string"},
    "time": {"type": "string", "format": "date-time"},
    "subject": {"type": "string"},
    "datacontenttype": {"type": "string"},
    "correlationid": {"type": "string"},
    "payloadversion": {"type": "string"},
    "time_epoch_micro_source": {"type": "integer"}
  },
  "required": ["id", "source", "specversion", "type", "time", "subject", "datacontenttype", "correlationid", "payloadversion"]
}
```

---

## Event Serialization Formats

### JSON Schema (Primary)

**Use Case:** CloudEvent keys, simple event payloads

**Subject Naming:** `<topic>-<record-name>`

**Example:**
```
Topic: orders.events
Key Subject: orders.events-com.company.cloudevents.CloudEvent-key
Value Subject: orders.events-com.company.events.OrderCreated
```

**Schema Registry Configuration:**
```scala
val serdesFactory = SerdesFactory(
  schemaRegistryUrl = "http://localhost:8081",
  schemaFormat = "json"
)

val keySerializer = serdesFactory.createKeySerializer[CloudEvent]
val valueSerializer = serdesFactory.createValueSerializer[OrderCreatedEvent]
```

**Benefits:**
- Human-readable
- Easy debugging
- No code generation required
- Direct JSON mapping

---

### Avro (Optional)

**Use Case:** Binary efficiency, backward compatibility

**Schema Example:**
```json
{
  "type": "record",
  "name": "OrderCreatedEvent",
  "namespace": "com.company.events",
  "fields": [
    {"name": "orderId", "type": "string"},
    {"name": "customerId", "type": "string"},
    {"name": "amount", "type": "double"},
    {"name": "currency", "type": "string"}
  ]
}
```

**Benefits:**
- Compact binary format
- Schema evolution (backward/forward compatibility)
- Code generation available

---

### Protobuf (Optional)

**Use Case:** gRPC integration, cross-language support

**Schema Example:**
```protobuf
syntax = "proto3";

package com.company.events;

message OrderCreatedEvent {
  string order_id = 1;
  string customer_id = 2;
  double amount = 3;
  string currency = 4;
}
```

**Benefits:**
- Efficient binary serialization
- gRPC native format
- Strong typing across languages

---

## Schema Evolution Patterns

### Backward Compatibility

**Rule:** New schema can read old data

**Example:**
```scala
// v1.0
case class OrderEvent(orderId: String, amount: Double)

// v2.0 (backward compatible)
case class OrderEvent(
  orderId: String,
  amount: Double,
  currency: String = "USD"  // Default value for old events
)
```

**Allowed Changes:**
- Add optional fields with defaults
- Remove optional fields

**Forbidden Changes:**
- Remove required fields
- Change field types

---

### Forward Compatibility

**Rule:** Old schema can read new data

**Example:**
```scala
// v1.0 reads v2.0 data
// Ignores new fields (currency)
case class OrderEvent(orderId: String, amount: Double)
```

**Allowed Changes:**
- Add new fields (ignored by old readers)

**Forbidden Changes:**
- Remove fields old readers expect
- Change field types

---

### Full Compatibility

**Rule:** Both backward AND forward compatible

**Best Practice:**
- Always add optional fields with defaults
- Never remove required fields
- Use JSON Schema `oneOf` for polymorphism

---

## Related Documents

**Model References:**
- [07 Models Overview](07-models-overview.md)
- [07.1 Probe Testing Models](07.1-probe-testing-models.md)

**Architecture:**
- [10.2 Serdes DSL Architecture](../10%20Kafka%20Streaming/10.2%20Serialization/10.2-serdes-dsl-architecture.md)
- [ADR-SERDES-001: JSON Schema Serialization](../../adr/ADR-SERDES-001-confluent-json-schema-serialization-strategy.md)
- [ADR-SERDES-002: Polymorphic Events](../../adr/ADR-SERDES-002-json-schema-oneof-polymorphic-events.md)

**CloudEvents Specification:**
- [CloudEvents 1.0](https://github.com/cloudevents/spec/blob/v1.0/spec.md)

---

**Last Updated:** 2025-11-26
**Status:** Active - CloudEvents 1.0 compliant
