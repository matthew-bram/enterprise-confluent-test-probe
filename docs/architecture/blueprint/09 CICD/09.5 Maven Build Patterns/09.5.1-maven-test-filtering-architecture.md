# 09.5.1 Maven Test Filtering Architecture

**Status**: âœ… Implemented (2025-10-19)
**Category**: CI/CD - Build Patterns
**Author**: Claude Code
**Related**: `maven-commands-reference.md`, `.claude/guides/BUILD.md`

---

## Executive Summary

This document describes the **Maven Test Filtering Architecture** implemented to enable independent execution of unit tests, component tests, or both across a multi-module Maven project. The solution provides developers with fine-grained control over test execution while maintaining module dependency compilation.

**Key Benefits:**
- ğŸš€ **Fast Feedback**: Unit tests execute in ~5-10s (vs ~5min for all tests)
- ğŸ¯ **Selective Testing**: Run only the tests you need (unit, component, or both)
- ğŸ“Š **Coverage Flexibility**: Generate coverage reports for any test type combination
- ğŸ”§ **Developer Ergonomics**: Simple, consistent commands for humans and AI
- âš™ï¸ **Always Compile Dependencies**: `-am` flag ensures dependencies build automatically

---

## Problem Statement

### Context

Test-Probe is a multi-module Maven project with 3 modules:
- `test-probe-common` â†’ Foundation models and contracts
- `test-probe-core` â†’ Actor system, FSM, Kafka streaming
- `test-probe-interfaces` â†’ REST/CLI/gRPC interfaces

**Dependency Chain**: `interfaces` â†’ `core` â†’ `common`

### Challenges

1. **No Test Type Separation**: Original profiles (`unit-only`, `component-only`) didn't actually filter tests
2. **Slow Feedback Loop**: Running all tests (~5 minutes) for a small code change
3. **Unclear Commands**: Developers unsure how to run specific test types
4. **Missing Dependency Compilation**: `-pl` flag without `-am` caused compilation failures
5. **No Coverage Flexibility**: Couldn't generate coverage for specific test types

### Requirements

1. Run unit tests only (fast feedback, no Docker)
2. Run component tests only (full integration with Docker)
3. Run all tests (unit + component)
4. Generate coverage reports for any test type combination
5. Module-specific or project-wide execution
6. Always compile dependencies automatically
7. Clear, documented command patterns

---

## Solution Architecture

### Design Principles

1. **Profile-Based Filtering**: Use Maven profiles to control test execution
2. **Property-Driven Configuration**: Use properties (`skipUnitTests`, `skipComponentTests`) to configure plugins
3. **Plugin-Specific Control**: Configure ScalaTest and Surefire plugins independently
4. **Dependency Awareness**: Always use `-am` flag for module-specific builds
5. **Consistent Patterns**: Same command structure across all modules

### Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Maven Parent POM                            â”‚
â”‚                                                                  â”‚
â”‚  Properties:                                                     â”‚
â”‚    - skipUnitTests: false (default)                             â”‚
â”‚    - skipComponentTests: false (default)                        â”‚
â”‚                                                                  â”‚
â”‚  Profiles:                                                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚    â”‚  unit-only     â”‚ component-   â”‚ coverage-         â”‚       â”‚
â”‚    â”‚                â”‚ only         â”‚ aggregate         â”‚       â”‚
â”‚    â”‚  skipComponent â”‚ skipUnit     â”‚ aggregateOnly:    â”‚       â”‚
â”‚    â”‚  Tests=true    â”‚ Tests=true   â”‚ true              â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Module POMs (core, interfaces, common)          â”‚
â”‚                                                                  â”‚
â”‚  ScalaTest Plugin:                                              â”‚
â”‚    <skipTests>${skipUnitTests}</skipTests>                      â”‚
â”‚                                                                  â”‚
â”‚  Surefire Plugin:                                               â”‚
â”‚    <skipTests>${skipComponentTests}</skipTests>                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Test Execution                             â”‚
â”‚                                                                  â”‚
â”‚  Unit Tests (ScalaTest):      Component Tests (Cucumber):       â”‚
â”‚    - *Spec.scala files         - *TestRunner.class             â”‚
â”‚    - Fast (~5-10s)             - Slow (~4-5min, Docker)         â”‚
â”‚    - No Docker required         - Requires Testcontainers       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Responsibilities

#### Parent POM (`pom.xml`)

**Properties**:
```xml
<properties>
    <skipUnitTests>false</skipUnitTests>
    <skipComponentTests>false</skipComponentTests>
</properties>
```

**Profiles**:
- `unit-only`: Sets `skipComponentTests=true`, `skipUnitTests=false`
- `component-only`: Sets `skipUnitTests=true`, `skipComponentTests=false`
- `coverage-aggregate`: Generates aggregate coverage across all modules

#### Module POMs

**ScalaTest Maven Plugin** (Unit Tests):
```xml
<plugin>
    <groupId>org.scalatest</groupId>
    <artifactId>scalatest-maven-plugin</artifactId>
    <configuration>
        <skipTests>${skipUnitTests}</skipTests>
    </configuration>
</plugin>
```

**Maven Surefire Plugin** (Component Tests):
```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <skipTests>${skipComponentTests}</skipTests>
        <includes>
            <include>**/*TestRunner.class</include>
            <include>**/*Runner.class</include>
        </includes>
    </configuration>
</plugin>
```

---

## Implementation Details

### Test Type Classification

| Test Type | Plugin | File Pattern | Duration | Docker | Scope |
|-----------|--------|-------------|----------|--------|-------|
| **Unit** | ScalaTest Maven Plugin | `*Spec.scala` | ~5-10s per module | No | Behavior, business logic |
| **Component** | Maven Surefire + Cucumber | `*TestRunner.class` | ~4-5min | Yes | Integration, workflows |

### Profile Configuration

| Profile | skipUnitTests | skipComponentTests | Use Case |
|---------|---------------|-------------------|----------|
| Default (no profile) | false | false | Run all tests |
| `-Punit-only` | false | **true** | Fast feedback, TDD |
| `-Pcomponent-only` | **true** | false | Integration validation |
| `-Pcoverage` | false | false | Enforce 70% minimum |
| `-Pcoverage-aggregate` | false | false | Cross-module coverage |

### Module Dependency Handling

**Critical Pattern**: Always use `-am` (also-make) flag when building specific modules.

```bash
# âŒ WRONG - May fail if dependencies not built
./mvnw test -pl test-probe-interfaces

# âœ… CORRECT - Automatically builds dependencies
./mvnw test -pl test-probe-interfaces -am
```

**Why**: The `-am` flag tells Maven to also build any modules that the specified module depends on. This ensures:
1. `test-probe-common` compiles before `test-probe-core`
2. `test-probe-core` compiles before `test-probe-interfaces`
3. All dependencies are available at test time

---

## Usage Patterns

### Module-Specific Test Execution

```bash
# Unit tests only - test-probe-core (338 tests, ~10s)
./mvnw test -Punit-only -pl test-probe-core -am

# Component tests only - test-probe-core (198 scenarios, ~4-5min)
./mvnw test -Pcomponent-only -pl test-probe-core -am

# All tests - test-probe-core (unit + component)
./mvnw test -pl test-probe-core -am
```

### Project-Wide Test Execution

```bash
# All unit tests across all modules (446 tests, ~15-20s)
./mvnw test -Punit-only

# All component tests across all modules (~5-10min)
./mvnw test -Pcomponent-only

# All tests (unit + component)
./mvnw test
```

### Coverage Report Generation

```bash
# Coverage for unit tests only - single module
./mvnw clean test scoverage:report -Punit-only -pl test-probe-core -am

# Coverage for component tests only - single module
./mvnw clean test scoverage:report -Pcomponent-only -pl test-probe-core -am

# Aggregate coverage across all modules
./mvnw clean test scoverage:report -Pcoverage-aggregate
```

### Compilation Without Tests

```bash
# Compile single module with dependencies
./mvnw compile -DskipTests -pl test-probe-core -am

# Compile all modules
./mvnw compile -DskipTests
```

---

## Test Statistics

### Test Distribution (as of 2025-10-19)

| Module | Unit Tests | Component Tests | Total | Coverage Target |
|--------|-----------|----------------|-------|----------------|
| test-probe-common | 0 | 0 | 0 | 70% |
| test-probe-core | 338 | 198 scenarios | 536 | 70% (unit), 85% (actors) |
| test-probe-interfaces | 108 | TBD | 108+ | 70% |
| **Total** | **446** | **198** | **644+** | **70% minimum** |

### Execution Times

| Scenario | Duration | Notes |
|----------|----------|-------|
| Unit tests - single module | ~5-10s | No Docker, fast feedback |
| Unit tests - all modules | ~15-20s | Parallel execution |
| Component tests - single module | ~4-5min | Docker Testcontainers startup |
| Component tests - all modules | ~5-10min | Sequential execution (Kafka container) |
| All tests - all modules | ~6-12min | Combined unit + component |

---

## Technical Decisions

### Why `skipTests` Instead of `skip`?

**Issue**: ScalaTest Maven Plugin 2.2.0 doesn't support the `skip` parameter.

**Solution**: Use `skipTests` parameter which is supported:

```xml
<!-- âŒ WRONG - Parameter not supported -->
<configuration>
    <skip>${skipUnitTests}</skip>
</configuration>

<!-- âœ… CORRECT - Uses supported parameter -->
<configuration>
    <skipTests>${skipUnitTests}</skipTests>
</configuration>
```

### Why Separate Properties Instead of Test Groups?

**Original Approach** (didn't work):
```xml
<profile>
    <id>unit-only</id>
    <properties>
        <test.groups>unit</test.groups>
    </properties>
</profile>
```

**Problem**: ScalaTest and Surefire don't share the same test group configuration mechanism.

**Solution**: Use plugin-specific skip properties that each plugin understands.

### Why Not Use Maven Surefire Exclusively?

**Reason**: ScalaTest Maven Plugin provides better integration with ScalaTest:
- Native Scala test discovery
- Better reporting for ScalaTest assertions
- Proper handling of ScalaTest lifecycle

**Trade-off**: Must configure two plugins separately, but gain better test framework integration.

---

## Migration Guide

### Updating Existing Commands

| Old Command | New Command | Notes |
|------------|-------------|-------|
| `./mvnw test -pl test-probe-core` | `./mvnw test -pl test-probe-core -am` | Add `-am` for dependencies |
| `./mvnw test -Punit-only` | No change | Works project-wide |
| `./mvnw test -Pcomponent-only` | No change | Now actually works! |
| `./mvnw compile -pl test-probe-core` | `./mvnw compile -pl test-probe-core -am` | Add `-am` for dependencies |

### For CI/CD Pipelines

```yaml
# Example GitHub Actions workflow
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Run Unit Tests
        run: ./mvnw test -Punit-only
        # Fast feedback, ~15-20s

  component-tests:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:dind
    steps:
      - name: Run Component Tests
        run: ./mvnw test -Pcomponent-only
        # Full integration, ~5-10min
```

---

## Troubleshooting

### Problem: Unit Tests Still Running with `-Pcomponent-only`

**Symptom**: ScalaTest tests execute when running `./mvnw test -Pcomponent-only`

**Cause**: Module POM doesn't have `skipTests` configuration for ScalaTest plugin

**Solution**: Ensure module POM has:
```xml
<plugin>
    <groupId>org.scalatest</groupId>
    <artifactId>scalatest-maven-plugin</artifactId>
    <configuration>
        <skipTests>${skipUnitTests}</skipTests>
    </configuration>
</plugin>
```

### Problem: Compilation Failures When Building Specific Module

**Symptom**: `./mvnw test -pl test-probe-interfaces` fails with "class not found"

**Cause**: Dependencies not compiled

**Solution**: Add `-am` flag:
```bash
./mvnw test -pl test-probe-interfaces -am
```

### Problem: Coverage Report Empty

**Symptom**: Scoverage report shows 0% coverage

**Cause**: Tests didn't run (likely skipped due to profile)

**Solution**: Verify tests ran:
```bash
./mvnw clean test scoverage:report -Punit-only -pl test-probe-core -am 2>&1 | grep "Tests run:"
```

---

## Future Enhancements

### Potential Improvements

1. **SIT (System Integration Tests) Profile**
   - Add `-Psit-only` profile for end-to-end tests
   - Separate from component tests for clarity

2. **Parallel Component Test Execution**
   - Investigate Kafka test container pooling
   - Enable parallel execution of component tests

3. **Test Execution Metrics**
   - Track test execution times per module
   - Generate trend reports for build optimization

4. **IDE Integration**
   - IntelliJ run configurations for each profile
   - VS Code tasks for common test scenarios

---

## References

### Documentation
- `maven-commands-reference.md` - Complete command reference
- `.claude/guides/BUILD.md` - Build command guide
- `.claude/guides/TESTING.md` - Testing standards

### Related ADRs
- ADR-001: Pekko Migration (dependency updates)
- ADR-002: Testing Strategy (test pyramid rationale)

### External Resources
- [Maven Profiles Documentation](https://maven.apache.org/guides/introduction/introduction-to-profiles.html)
- [Maven Reactor Options](https://maven.apache.org/guides/mini/guide-multiple-modules.html)
- [ScalaTest Maven Plugin](https://www.scalatest.org/user_guide/using_the_scalatest_maven_plugin)
- [Scoverage Maven Plugin](https://github.com/scoverage/scoverage-maven-plugin)

---

## Changelog

| Date | Change | Author |
|------|--------|--------|
| 2025-10-19 | Initial architecture documentation for Maven test filtering | Claude Code |

---

**Last Updated**: 2025-10-19
**Document Version**: 1.0
**Review Status**: Initial Release
