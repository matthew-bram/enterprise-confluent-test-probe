# Test-Probe Interfaces Configuration
# ====================================
#
# This file contains default configuration for the test-probe-interfaces module.
# These settings can be overridden in application.conf.
#
# Interface Selection:
# The application uses ONE interface type based on which config section
# is provided in application.conf:
# - test-probe.interfaces.rest   : HTTP/JSON API using Pekko HTTP (production)
# - test-probe.interfaces.cli    : Command-line interface (future)
# - test-probe.interfaces.grpc   : gRPC API (future)
#
# This matches the services module pattern (vault.provider, block-storage.provider)
# where you select ONE provider/interface, not toggle multiple via enabled flags.

test-probe.interfaces {

  # REST HTTP Interface Configuration
  rest {
    # Host to bind (0.0.0.0 = all interfaces, 127.0.0.1 = localhost only)
    host = "0.0.0.0"
    host = ${?REST_HOST}

    # Port to bind
    port = 8080
    port = ${?REST_PORT}

    # Request timeout (max time for request processing)
    # Must be > ask-timeout to allow actor response before HTTP timeout
    timeout = 30 seconds

    # Graceful shutdown timeout (wait for in-flight requests)
    graceful-shutdown-timeout = 10 seconds

    # Actor ask timeout (must be < request timeout)
    # Should match core module's test-probe.core.actor-system.timeout (25s)
    ask-timeout = 25s

    # Circuit Breaker Configuration
    # Should match core module's test-probe.core.circuit-breaker settings
    circuit-breaker-max-failures = 5
    circuit-breaker-call-timeout = 25s
    circuit-breaker-reset-timeout = 30s

    # HTTP Server Limits
    # Maximum concurrent requests (backpressure beyond this)
    max-concurrent-requests = 100

    # Maximum request body size (10MB default)
    max-request-size = 10485760

    # Maximum URI length (8KB default)
    max-uri-length = 8192

    # Retry-After Configuration
    # Controls HTTP "Retry-After" header values in 503 Service Unavailable responses.
    # Format: Duration string (e.g., "30s", "1m", "2h")

    # Retry-After for circuit breaker open (service temporarily unavailable)
    retry-after-service-unavailable = "30s"
    retry-after-service-unavailable = ${?REST_RETRY_AFTER_SERVICE_UNAVAILABLE}

    # Retry-After for system not ready (still initializing)
    retry-after-not-ready = "5s"
    retry-after-not-ready = ${?REST_RETRY_AFTER_NOT_READY}
  }

  # Future: CLI Interface Configuration
  # cli {
  #   enabled = false
  #   prompt = "test-probe> "
  #   history-file = ${user.home}/.test-probe-history
  # }

  # Future: gRPC Interface Configuration
  # grpc {
  #   enabled = false
  #   host = "0.0.0.0"
  #   port = 9090
  # }
}

# Pekko HTTP Configuration
# Note: This is at root level (not namespaced) as required by Pekko HTTP
pekko.http {
  server {
    # Request timeout (aligns with test-probe.interfaces.rest.timeout)
    request-timeout = ${test-probe.interfaces.rest.timeout}

    # Idle timeout (how long to keep connection open with no activity)
    idle-timeout = 60s

    # Max connections (concurrent TCP connections)
    max-connections = ${test-probe.interfaces.rest.max-concurrent-requests}

    # Parsing limits
    parsing {
      max-content-length = ${test-probe.interfaces.rest.max-request-size}
      max-uri-length = ${test-probe.interfaces.rest.max-uri-length}
      max-header-count = 64
    }
  }
}
